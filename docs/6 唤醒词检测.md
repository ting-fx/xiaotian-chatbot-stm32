# 添加Porcupine唤醒词检测功能

## 1. Porcupine简介

Porcupine 是 Picovoice 提供的一款高精度、轻量级 的唤醒词（Wake Word）检测引擎，体积小、计算效率高，适用于IoT和嵌入式设备。它支持多种硬件和操作系统平台，并提供 包括中文在内的多语言支持。非商用项目开发者可以免费使用 Porcupine 的预训练唤醒词和自定义唤醒词。


## 2. 官方MCU使用文档

https://picovoice.ai/docs/quick-start/porcupine-microcontroller/

## 3. 遇到的问题

- 使用 Porcupine v4.0
	- 官方示例中的 中文唤醒词模型（pv_params.h）：初始化失败，返回 PV_STATUS_INVALID_ARGUMENT
	- 自行训练的 v4.0 中文唤醒词模型：同样初始化失败，错误一致

- 切换至 Porcupine v3.0.4
	- 官方示例中的中文唤醒词 可以正常初始化并工作


## 4. 唤醒词检测流程实现

```c
uint8_t wakeword_detection(){
    uint8_t status = audio_record(RECORD_MODE_WAKEWORD);

    if(status != STATUS_SUCCESS)
    {
    	return status;
    }

    pv_porcupine_t *handle = NULL;

 	status = pv_porcupine_init(
	        ACCESS_KEY,
	        MEMORY_BUFFER_SIZE,
	        memory_buffer,
	        1,
	        &keyword_model_sizes,
	        &keyword_models,
	        &sensitivity,
	        &handle);

    if (status != PV_STATUS_SUCCESS)
    {
    	return STATUS_FAILURE;
    }

    ULONG actual_events;

    /* 通知GUI线程录音开始，更新界面显示 */
    tx_event_flags_set(&xt_event_group, XT_EVENT_GUI_RECORDING, TX_OR);

    while (1)
    {
    	/* 获取音频数据准备就绪标志 */
    	tx_event_flags_get(&xt_event_group, XT_EVENT_AUDIO_MASK, TX_OR_CLEAR , &actual_events, TX_WAIT_FOREVER);

    	if(actual_events & XT_EVENT_AUDIO_WAKEWORD_READY)
    	{
    		AUDIO_DATA audio_data;

    		/* 获取一帧音频数据 */
			if (audio_record_data_get(&audio_data) == STATUS_SUCCESS) {
				int32_t keyword_index;

				/* 开始检测唤醒词 */
				const pv_status_t is_wakeword = pv_porcupine_process(handle, (int16_t *)audio_data.data_ptr, &keyword_index);
				if((is_wakeword == PV_STATUS_SUCCESS) && (keyword_index != -1))
				{
					/* 检测到唤醒词 */
					break;
				}
			}
    	}
    }

    /* 通知GUI线程检测到唤醒词，更新界面显示 */
    tx_event_flags_set(&xt_event_group, XT_EVENT_GUI_DETECTED, TX_OR);

    pv_porcupine_delete(handle);
    audio_stop();

    return STATUS_SUCCESS;
}
```

注意：采样率必须与 pv_sample_rate() 返回值一致，且为 16 位线性编码（PCM）。Porcupine 只处理 单声道 音频。
